# Update Changelog
#
# Atomic workflow for updating CHANGELOG.md with new release notes.
# Prepends the latest version entry to the changelog file and commits
# the change back to the repository.
#
# CHANGELOG FORMAT
# ================
# Uses Keep a Changelog format (https://keepachangelog.com):
#
# ## [1.2.3] - 2024-01-15
# ### Added
# - New feature description
# ### Fixed
# - Bug fix description
#
# USAGE EXAMPLE
# =============
#   jobs:
#     update-changelog:
#       needs: ["create-release", "next-version"]
#       uses: <org>/.github/.github/workflows/update-changelog.yml@main
#       with:
#         version: ${{ needs.next-version.outputs.version }}
#         changelog: ${{ needs.next-version.outputs.changelog }}
#       secrets:
#         github-token: ${{ secrets.GH_TOKEN }}

name: Update Changelog

on:
  workflow_call:
    inputs:
      version:
        description: "Version number (e.g., 1.2.3)"
        required: true
        type: string
      changelog:
        description: "Changelog content from conventional commits"
        required: true
        type: string
    secrets:
      github-token:
        description: "GitHub token for pushing changelog updates"
        required: true

jobs:
  update-changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.github-token }}
          ref: ${{ github.ref }}

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ inputs.version }}"
          DATE="${{ steps.date.outputs.date }}"
          CHANGELOG_CONTENT='${{ inputs.changelog }}'

          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << 'HEADER'
          # Changelog

          All notable changes to this project will be documented in this file.

          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

          HEADER
          fi

          # Create the new version entry
          NEW_ENTRY="## [${VERSION}] - ${DATE}

          ${CHANGELOG_CONTENT}

          "

          # Insert new entry after the header (after first blank line following header)
          if grep -q "^## \[" CHANGELOG.md; then
            # If there are existing version entries, insert before the first one
            awk -v entry="$NEW_ENTRY" '
              /^## \[/ && !inserted {
                print entry
                inserted=1
              }
              {print}
            ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
          else
            # No existing entries, append to end
            echo "$NEW_ENTRY" >> CHANGELOG.md
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changelog changes to commit"
          else
            git commit -m "docs: update CHANGELOG.md for v${{ inputs.version }}"
            git push
          fi
