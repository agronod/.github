name: Claude Assistant

on:
  workflow_call:
    secrets:
      claude_code_oauth_token:
        required: true

jobs:
  # Interactive @claude mentions in comments, reviews, and issues
  claude-interactive:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.claude_code_oauth_token }}

          # Use sticky comment for consolidated responses
          use_sticky_comment: true

          # Context loading for all @claude interactions
          claude_args: |
            --append-system-prompt "Before responding to any request:
            1) Map the .agents/steering/ structure to discover available documentation
            2) Read relevant context.md files based on the changes being discussed
            3) Read CLAUDE.md for overall project guidelines."

  # Automatic PR review with progress tracking
  claude-pr-review:
    if: |
      github.event_name == 'pull_request' &&
      github.actor != 'claude[bot]' &&
      github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: PR Review with Progress Tracking
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.claude_code_oauth_token }}

          # Enable progress tracking for automation mode
          track_progress: true

          # Instructions for the PR review
          prompt: |
            <context>
            Map .agents/steering/ and read relevant context.md files for areas touched by this PR.
            Read CLAUDE.md for project guidelines.
            </context>

            <focus priority="ordered">
            1. Safety - Security vulnerabilities, data integrity risks
            2. Bugs - Runtime errors, edge cases, logic errors
            3. Conventions - Contradicts steering context or CLAUDE.md
            4. Scope - Changes that don't belong in this repository
            5. Cost - N+1 queries, unbounded loops, expensive operations
            </focus>

            <constraints>
            - Skip: style nitpicks, missing tests, docs, praise
            - Use inline comments for file-specific issues (enables GitHub suggestions)
            - Summary comment only for overall assessment
            </constraints>

            <workflow>
            1. Read the PR diff and changed files
            2. For each issue found: post inline comment at the exact line using create_inline_comment tool
            3. After all inline comments: post one summary comment with overall assessment
            </workflow>

            <inline-comment-format>
            **[TYPE]** Brief issue title

            Why it matters.

            ```suggestion
            replacement lines only - must match exact line count being replaced
            ```

            CRITICAL: Suggestions replace the commented lines exactly. Include ONLY the replacement code, not surrounding context. If adding 3 lines to replace 1, the suggestion must contain exactly those 3 new lines.
            </inline-comment-format>

            <summary-comment-format>
            ### Review Summary
            One sentence: scope, risk level, key concerns.

            **Issues found:** N (linked via inline comments above)

            ### Watch
            Optional. Max 2 items. Non-blocking observations that could drift into problems.
            - `path/file.ts:99` - Brief concern
            </summary-comment-format>

            <example-inline-comment>
            Comment on line: `const name = user.name;`

            **[BUG]** Null reference on undefined user

            Will throw TypeError when user lookup fails.

            ```suggestion
            if (!user) return null;
            const name = user.name;
            ```

            (Replaces 1 line with 2 lines - suggestion contains exactly the replacement)
            </example-inline-comment>

            <example-summary-clean>
            ### Review Summary
            Focused changes with low risk.

            **Issues found:** 0

            âœ… No concerns.
            </example-summary-clean>

          # Tools for comprehensive PR review
          claude_args: |
            --allowedTools mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Bash(find:*)

# When track_progress is enabled:
# - Creates a tracking comment with progress checkboxes
# - Preserves all PR context (comments, attachments, images)
# - Updates progress as the review proceeds
