# .NET NuGet Pack and Publish
#
# Atomic workflow for building, packing, and publishing .NET NuGet packages
# to GitHub Packages. Designed for library projects that publish NuGet packages
# rather than container images.
#
# PACKAGE VERSIONING
# ==================
# Version is injected via /p:PackageVersion parameter during pack.
# For stable releases, use semantic version (e.g., 1.2.3)
# For pre-releases, use PR-specific version (e.g., 1.2.3-42-abc1234)
#
# REGISTRY
# ========
# Publishes to GitHub Packages NuGet registry:
# https://nuget.pkg.github.com/{owner}/index.json
#
# USAGE EXAMPLE
# =============
#   jobs:
#     pack:
#       uses: <org>/.github/.github/workflows/dotnet-pack-nuget.yml@main
#       with:
#         dotnet-version: "8.0"
#         package-version: "1.2.3"
#       secrets:
#         github-user: ${{ secrets.GH_USER }}
#         github-token: ${{ secrets.GH_TOKEN }}

name: Pack and Publish NuGet

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: ".NET SDK version"
        required: true
        type: string
      working-directory:
        description: "Path to the directory containing the .NET solution or project"
        default: "."
        type: string
      package-version:
        description: "Semantic version for the NuGet package"
        required: true
        type: string
      configuration:
        description: "Build configuration"
        default: "Release"
        type: string
    secrets:
      github-user:
        description: "GitHub username for NuGet feed authentication"
        required: true
      github-token:
        description: "GitHub token for NuGet feed authentication and publishing"
        required: true

jobs:
  pack-and-publish:
    name: Pack and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Restore
        working-directory: ${{ inputs.working-directory }}
        run: dotnet restore
        env:
          GITHUB_USERNAME: ${{ secrets.github-user }}
          GITHUB_TOKEN: ${{ secrets.github-token }}

      - name: Build
        working-directory: ${{ inputs.working-directory }}
        run: dotnet build --configuration ${{ inputs.configuration }} --no-restore

      - name: Pack
        working-directory: ${{ inputs.working-directory }}
        run: |
          dotnet pack --configuration ${{ inputs.configuration }} --no-build \
            /p:PackageVersion=${{ inputs.package-version }} \
            --output ./nupkgs

      - name: Publish to GitHub Packages
        working-directory: ${{ inputs.working-directory }}
        run: |
          dotnet nuget push ./nupkgs/*.nupkg \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --api-key ${{ secrets.github-token }} \
            --skip-duplicate
