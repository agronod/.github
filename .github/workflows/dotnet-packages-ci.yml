# .NET NuGet Package CI/CD Pipeline
#
# Complete CI/CD workflow for .NET libraries that publish NuGet packages.
# Orchestrates testing, versioning, package building, publishing to GitHub
# Packages, and GitHub release creation.
#
# PIPELINE STAGES
# ===============
# 1. test         - Run dotnet test with configurable filter (optional)
# 2. next-version - Calculate semantic version from conventional commits
# 3. pack         - Build and publish NuGet package to GitHub Packages
# 4. release      - Create GitHub release with changelog
# 5. changelog    - Update CHANGELOG.md with release notes
#
# PACKAGE VERSIONING
# ==================
# Uses semantic versioning based on conventional commits:
# - feat: → minor version bump
# - fix:  → patch version bump
# - BREAKING CHANGE: → major version bump
#
# USAGE EXAMPLE
# =============
#   name: CI
#   on:
#     push:
#       branches: [main]
#
#   jobs:
#     ci:
#       uses: <org>/.github/.github/workflows/dotnet-packages-ci.yml@main
#       with:
#         dotnet-version: "8.0"
#         package-name: "Agronod.Mvc"
#       secrets:
#         github-user: ${{ secrets.GH_USER }}
#         github-token: ${{ secrets.GH_TOKEN }}

name: .NET Package CI

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: ".NET SDK version"
        required: true
        type: string
      working-directory:
        description: "Path to the directory containing the .NET solution or project"
        default: "."
        type: string
      package-name:
        description: "NuGet package name"
        required: true
        type: string
      test:
        description: "Run tests"
        default: true
        type: boolean
      test-filter:
        description: "XUnit test filter expression"
        default: "Category!=e2e"
        type: string
    secrets:
      github-user:
        description: "GitHub username for NuGet feed authentication"
        required: true
      github-token:
        description: "GitHub token for builds, publishing, and releases"
        required: true

jobs:
  test:
    uses: ./.github/workflows/dotnet-test.yml
    with:
      dotnet-version: ${{ inputs.dotnet-version }}
      working-directory: ${{ inputs.working-directory }}
      test-filter: ${{ inputs.test-filter }}
      enabled: ${{ inputs.test }}
    secrets:
      github-user: ${{ secrets.github-user }}
      github-token: ${{ secrets.github-token }}

  next-version:
    needs: "test"
    uses: ./.github/workflows/next-version.yaml
    secrets:
      github-token: ${{ secrets.github-token }}

  pack-and-publish:
    needs: "next-version"
    uses: ./.github/workflows/dotnet-pack-nuget.yml
    with:
      dotnet-version: ${{ inputs.dotnet-version }}
      working-directory: ${{ inputs.working-directory }}
      package-version: ${{ needs.next-version.outputs.version }}
    secrets:
      github-user: ${{ secrets.github-user }}
      github-token: ${{ secrets.github-token }}

  create-release:
    needs: ["pack-and-publish", "next-version"]
    uses: ./.github/workflows/create-release.yml
    with:
      tag: ${{ needs.next-version.outputs.tag }}
      version: ${{ needs.next-version.outputs.version }}
      changelog: ${{ needs.next-version.outputs.changelog }}

  update-changelog:
    needs: ["create-release", "next-version"]
    uses: ./.github/workflows/update-changelog.yml
    with:
      version: ${{ needs.next-version.outputs.version }}
      changelog: ${{ needs.next-version.outputs.changelog }}
    secrets:
      github-token: ${{ secrets.github-token }}
