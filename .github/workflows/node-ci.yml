# Node.js CI/CD Pipeline
#
# Complete CI/CD workflow for Node.js applications. Orchestrates testing,
# versioning, container builds, security scanning, release creation, and
# GitOps-based deployment promotion.
#
# PIPELINE STAGES
# ===============
# 1. test         - Run npm test (optional, default: enabled)
# 2. next-version - Calculate semantic version from conventional commits
# 3. build        - Build and push container image to Quay.io
# 4. scan         - Trivy vulnerability scan (optional, default: enabled)
# 5. release      - Create GitHub release with changelog
# 6. promote      - Update GitOps repo to trigger deployment
#
# VERSIONING
# ==========
# Uses conventional commits to determine version bumps:
# - feat: → minor version bump (1.0.0 → 1.1.0)
# - fix:  → patch version bump (1.0.0 → 1.0.1)
# - BREAKING CHANGE: → major version bump (1.0.0 → 2.0.0)
#
# USAGE EXAMPLE
# =============
#   name: CI/CD
#   on:
#     push:
#       branches: [main]
#
#   jobs:
#     build:
#       uses: <org>/.github/.github/workflows/node-ci.yml@main
#       with:
#         application-name: my-service
#         application-folder: services
#       secrets:
#         github-user: ${{ secrets.GH_USER }}
#         github-token: ${{ secrets.GH_TOKEN }}
#         registry-username: ${{ secrets.QUAY_USERNAME }}
#         registry-password: ${{ secrets.QUAY_PASSWORD }}

name: Node CI

on:
  workflow_call:
    inputs:
      node-version:
        default: "20.15.0"
        type: string
      working-directory:
        description: "Path to the directory containing the Node.js project"
        default: "."
        type: string
      rhacs-central-endpoint:
        description: "The endpoint URL of the RHACS Central server for authentication."
        type: string
        required: false
      test:
        default: true
        type: boolean
      application-name:
        required: true
        type: string
      application-folder:
        required: true
        type: string
      check-image:
        default: true
        type: boolean
      dockerfile:
        description: "The path to the Dockerfile relative to the repository root"
        type: string
        required: false
        default: "Dockerfile"
      image-tag-parameter:
        default: "image.tag"
        type: string
      environment:
        description: "Override environment (e.g., dev, test, staging, production). If not provided, will be calculated from branch."
        required: false
        type: string
      enforce-scanning:
        default: false
        type: boolean
      imageName:
        description: "Optional override for the image name (without tag). If not provided, defaults to quay.io/agronod/ghcr.io/<repository>"
        required: false
        type: string
    secrets:
      github-user:
        description: "Github username for the container registry"
        required: true
      github-token:
        description: "Github token to be able to build inside the container"
        required: true
      registry-username:
        description: "The username for the container registry"
        required: true
      registry-password:
        description: "The password for the container registry"
        required: true
      container-build-args:
        description: "Container build args"
        required: false
      container-secrets:
        description: "Container secrets"
        required: false

jobs:
  test:
    uses: ./.github/workflows/node-test.yml
    with:
      node-version: ${{ inputs.node-version }}
      working-directory: ${{ inputs.working-directory }}
      enabled: ${{ inputs.test }}
    secrets:
      github-token: ${{ secrets.github-token }}

  next-version:
    needs: "test"
    uses: ./.github/workflows/next-version.yaml
    secrets:
      github-token: ${{ secrets.github-token }}

  build-and-push-image:
    needs: "next-version"
    uses: ./.github/workflows/build-and-push-image.yml
    with:
      registry-url: "quay.io"
      image-name: ${{ inputs.imageName != '' && inputs.imageName || format('quay.io/agronod/ghcr.io/{0}', github.repository) }}
      tag: ${{ needs.next-version.outputs.version }}
      working-directory: ${{ inputs.working-directory }}
      dockerfile: ${{ inputs.dockerfile }}
    secrets:
      registry-username: ${{ secrets.registry-username }}
      registry-password: ${{ secrets.registry-password }}
      container-build-args: ${{ secrets.container-build-args }}
      container-secrets: ${{ secrets.container-secrets }}

  scan-and-check-image:
    needs: "build-and-push-image"
    uses: ./.github/workflows/scan-and-check-image.yml
    with:
      image: ${{ needs.build-and-push-image.outputs.image }}
      check-image: ${{ inputs.check-image }}
      enforce-scanning: ${{ inputs.enforce-scanning }}
    secrets:
      registry-username: ${{ secrets.registry-username }}
      registry-password: ${{ secrets.registry-password }}
      github-token: ${{ secrets.github-token }}

  create-release:
    needs: ["scan-and-check-image", "next-version"]
    uses: ./.github/workflows/create-release.yml
    with:
      tag: ${{ needs.next-version.outputs.tag }}
      version: ${{ needs.next-version.outputs.version }}
      changelog: ${{ needs.next-version.outputs.changelog }}

  promote-application:
    needs: ["create-release", "build-and-push-image"]
    uses: ./.github/workflows/promote-application.yml
    with:
      tag: ${{ needs.build-and-push-image.outputs.tag }}
      application-name: ${{ inputs.application-name }}
      application-folder: ${{ inputs.application-folder }}
      image-tag-parameter: ${{ inputs.image-tag-parameter }}
      environment: ${{ inputs.environment }}
    secrets:
      github-token: ${{ secrets.github-token }}
