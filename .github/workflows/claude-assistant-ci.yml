# Claude AI Assistant for GitHub Repositories
#
# Reusable workflow providing AI-powered assistance through two modes:
# - Interactive @claude mentions in issues, comments, and PR reviews
# - Automatic PR review with inline comments and GitHub suggestions
#
# JOBS
# ====
# claude-interactive: Responds to @claude mentions anywhere in the repository.
#   Triggers: issue_comment, pull_request_review_comment, pull_request_review, issues
#   Uses sticky comments to consolidate responses in a single thread.
#
# claude-pr-review: Automatic code review on every pull request.
#   Triggers: pull_request (opened, synchronize, reopened)
#   Posts inline comments with GitHub suggestions for actionable fixes.
#   Focus areas: security, bugs, conventions, scope creep, performance.
#
# SETUP
# =====
# 1. Generate a Claude Code OAuth token:
#    - Visit https://console.anthropic.com/ → API Keys
#    - Or use Claude Code CLI: `claude auth`
#
# 2. Add the token as a repository secret:
#    - Settings → Secrets and variables → Actions → New repository secret
#    - Name: CLAUDE_CODE_OAUTH_TOKEN
#    - Value: <your token>
#
# 3. Create a caller workflow in your repository (see usage example below)
#
# USAGE EXAMPLE
# =============
# Create .github/workflows/claude-assistant.yml in your repository:
#
#   name: Claude Assistant
#   on:
#     issue_comment:
#       types: [created]
#     pull_request_review_comment:
#       types: [created]
#     pull_request_review:
#       types: [submitted]
#     issues:
#       types: [opened, edited]
#     pull_request:
#       types: [opened, synchronize, reopened]
#
#   jobs:
#     claude:
#       uses: <org>/actions/.github/workflows/ci-claude-assistant.yml@v1
#       secrets:
#         claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

name: Claude Assistant

on:
  workflow_call:
    secrets:
      claude_code_oauth_token:
        required: true

jobs:
  # Interactive @claude mentions in comments, reviews, and issues
  claude-interactive:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.claude_code_oauth_token }}

          # Use sticky comment for consolidated responses
          use_sticky_comment: true

          # Context loading for all @claude interactions
          claude_args: |
            --append-system-prompt "Before responding to any request:
            1) Map the .agents/steering/ structure to discover available documentation
            2) Read relevant context.md files based on the changes being discussed
            3) Read CLAUDE.md for overall project guidelines."

  # Automatic PR review with progress tracking
  claude-pr-review:
    if: |
      github.event_name == 'pull_request' &&
      github.actor != 'claude[bot]' &&
      github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: PR Review with Progress Tracking
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.claude_code_oauth_token }}

          # Enable progress tracking for automation mode
          track_progress: true

          # Instructions for the PR review
          prompt: |
            <context>
            Map .agents/steering/ and read relevant context.md files for areas touched by this PR.
            Read CLAUDE.md for project guidelines.
            </context>

            <focus priority="ordered">
            1. Safety - Security vulnerabilities, data integrity risks
            2. Bugs - Runtime errors, edge cases, logic errors
            3. Conventions - Contradicts steering context or CLAUDE.md
            4. Scope - Changes that don't belong in this repository
            5. Cost - N+1 queries, unbounded loops, expensive operations
            </focus>

            <constraints>
            - Skip: style nitpicks, missing tests, docs, praise, import organization
            - Do NOT suggest reformatting imports, objects, or arrays across multiple lines
            - Use inline comments for file-specific issues (enables GitHub suggestions)
            - Summary comment only for overall assessment
            </constraints>

            <workflow>
            1. Read the PR diff and changed files
            2. For each issue found: post inline comment at the exact line using create_inline_comment tool
            3. After all inline comments: post one summary comment with overall assessment
            </workflow>

            <inline-comment-format>
            **[TYPE]** Brief issue title

            Why it matters.

            ```suggestion
            replacement code
            ```
            </inline-comment-format>

            <suggestion-rules>
            CRITICAL - GitHub suggestions replace ONLY the exact lines the comment spans:
            - Single-line comment → suggestion replaces that ONE line only
            - Multi-line comment (startLine to line) → suggestion replaces that range only

            NEVER suggest reformatting multi-line statements (imports, objects, arrays) from a single-line comment.
            If a fix requires changing N lines, the comment MUST span all N lines using startLine parameter.

            SAFE: Bug fix on the exact line commented
            UNSAFE: Reformatting a 20-line import block from a comment on line 20
            </suggestion-rules>

            <summary-comment-format>
            ### Review Summary
            One sentence: scope, risk level, key concerns.

            **Issues found:** N (linked via inline comments above)

            ### Watch
            Optional. Max 2 items. Non-blocking observations that could drift into problems.
            - `path/file.ts:99` - Brief concern
            </summary-comment-format>

            <example-inline-single-line>
            Comment on single line: `const name = user.name;`

            **[BUG]** Null reference on undefined user

            Will throw TypeError when user lookup fails.

            ```suggestion
            const name = user?.name ?? 'Unknown';
            ```
            </example-inline-single-line>

            <example-inline-multi-line>
            Comment spanning lines 5-7 (using startLine=5, line=7):
            ```
            const config = {
              timeout: 5000
            };
            ```

            **[BUG]** Missing required retry option

            ```suggestion
            const config = {
              timeout: 5000,
              retry: 3
            };
            ```
            </example-inline-multi-line>

            <example-summary-clean>
            ### Review Summary
            Focused changes with low risk.

            **Issues found:** 0

            ✅ No concerns.
            </example-summary-clean>

          # Tools for comprehensive PR review
          claude_args: |
            --allowedTools mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Bash(find:*)

# When track_progress is enabled:
# - Creates a tracking comment with progress checkboxes
# - Preserves all PR context (comments, attachments, images)
# - Updates progress as the review proceeds
